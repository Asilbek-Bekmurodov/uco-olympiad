name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Deploy to Server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST_IP }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # 1. Manba (Source) papkasiga kirish
          # Agar papka yo'q bo'lsa, uni yaratib clone qilamiz (birinchi marta uchun)
          if [ ! -d "/home/ubuntu/uco-olympiad" ]; then
            git clone https://github.com/Asilbek-Bekmurodov/uco-olympiad.git /home/ubuntu/project_source
          fi

          # 2. Yangi kodni olish
          cd /home/ubuntu/uco-olympiad
          git pull origin main

          # 3. Kutubxonalarni o'rnatish va Build qilish
          # npm ci - bu 'npm install'ga qaraganda xavfsizroq va tezroq (CI uchun)
          npm install
          npm run build

          # 4. TAYYOR FAYLLARNI NGINX PAPKASIGA KO'CHIRISH
          # Diqqat! Sizda 'dist' yoki 'build' papka ekanligini tekshiring (quyida izoh bor)
          
          # Eski fayllarni tozalash (xavfsizlik uchun)
          rm -rf /var/www/uco-olympiad/html/*
          
          # Yangi fayllarni ko'chirish (Vite ishlatayotgan bo'lsangiz 'dist', React CRA bo'lsa 'build' bo'ladi)
          cp -r dist/* /var/www/uco-olympiad/html/
          
          # 5. Nginxni ogohlantirish (shart emas, lekin tavsiya etiladi)
          # sudo systemctl reload nginx
          
          echo "Deploy muvaffaqiyatli yakunlandi! ðŸš€"