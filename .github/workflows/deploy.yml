name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Deploy to Server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST_IP }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # 1. To'g'ri papkaga kirish yoki yaratish
          if [ ! -d "/home/ubuntu/uco-olympiad" ]; then
            # O'zgartirildi: project_source -> uco-olympiad
            git clone https://github.com/Asilbek-Bekmurodov/uco-olympiad.git /home/ubuntu/uco-olympiad
          fi

          # 2. Yangi kodni olish
          cd /home/ubuntu/uco-olympiad
          
          # Gitdagi o'zgarishlarni majburan olish (konflikt bo'lmasligi uchun)
          git reset --hard origin/main
          git pull origin main

          # 3. Kutubxonalarni o'rnatish va Build qilish
          npm install
          npm run build

          # 4. TAYYOR FAYLLARNI NGINX PAPKASIGA KO'CHIRISH
          
          # Agar maqsad papka yo'q bo'lsa, uni yaratamiz (Xavfsizlik uchun)
          sudo mkdir -p /var/www/uco-olympiad/html
          
          # Ruxsatlarni to'g'irlash (ubuntu yozishi uchun)
          sudo chown -R ubuntu:ubuntu /var/www/uco-olympiad/html

          # Eski fayllarni tozalash
          rm -rf /var/www/uco-olympiad/html/*
          
          # Yangi fayllarni ko'chirish
          # DIQQAT: Agar sizda 'dist' papkasi bo'lsa. Agar 'build' bo'lsa, pastdagini o'zgartiring.
          cp -r dist/* /var/www/uco-olympiad/html/
          
          echo "Deploy muvaffaqiyatli yakunlandi! ðŸš€"